---
title: "GraphQL ã‚’å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§å§‹ã‚ã¦ã¿ã‚‹"
emoji: "ğŸ”°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [GraphQL]
published: true
---

GraphQLã«ã¤ã„ã¦ã¯ã‚ˆãè¨˜äº‹ã§è¦‹ã¦ã„ã¦å­˜åœ¨ã¯çŸ¥ã£ã¦ã„ãŸã‚‚ã®ã®ã€  
å®Ÿéš›ã«è©¦ã›ã¦ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€æ”¹ã‚ã¦èª¿æŸ»ã¨å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã—ãŸã€‚  


## GraphQL æ¦‚è¦

GraphQLã¨ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚µãƒ¼ãƒãƒ¼ã®é€šä¿¡ã®ãŸã‚ã®è¨€èªä»•æ§˜ã§ã™ã€‚  
æ§˜ã€…ãªè¨€èªã§æ§˜ã€…ãªå®Ÿè£…ãŒã‚ã‚Šã€å¹…åºƒã„ç’°å¢ƒã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã£ã¦ã„ã¾ã™ã€‚  
[https://graphql.org/code/](https://graphql.org/code/)

ç‰¹å¾´ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚‚ã®ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

- ã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚Šå‹å®‰å…¨ãªé–‹ç™ºãŒã§ãã‚‹ã€‚
- ç‹¬è‡ªã®ã‚¯ã‚¨ãƒªè¨€èªã«ã‚ˆã£ã¦ä¸€åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§éä¸è¶³ãªããƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹ã€‚

GraphQLã®åˆ©ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ãŒå¤§é›‘æŠŠã«ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã«ãªã‚Šã¾ã™ã€‚

- ã‚µãƒ¼ãƒãƒ¼å´ã§APIã‚„ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨ãã®å®Ÿè£…ã‚’è¡Œãªã†ã€‚
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯GraphQLç‹¬è‡ªã®ã‚¯ã‚¨ãƒªè¨€èªã‚’ç”¨ã„ã¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€æ›´æ–°ãªã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã€‚
    - HTTPã®POSTã§ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã‚‹ã€‚
    - GraphQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ã‚’ä½¿ã†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã©ã‚‚ã„ã„æ„Ÿã˜ã«ã‚„ã£ã¦ãã‚Œã‚‹ã€‚

RestAPIã ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹æœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨æœ¬æƒ…å ±ã‚’ãã‚Œãã‚Œã®APIã‹ã‚‰å–å¾—ã—ã¦å¿…è¦ãªå±æ€§ã‚’å–æ¨é¸æŠã—ã€çµåˆã™ã‚‹ã¨ã„ã£ãŸæµã‚Œã«ãªã‚‹ã“ã¨ãŒå¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚

ã—ã‹ã—ã€GraphQLã§ã¯å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã¨å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒ‡å®šã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã€æ§˜ã€…ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦çµåˆã™ã‚‹ã¨ã„ã£ãŸã“ã¨ãŒä¸è¦ã¨ãªã‚Šã¾ã™ã€‚

IDãŒ 0001 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã¨æŒã£ã¦ã„ã‚‹æœ¬æƒ…å ±ã‚’æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªã®ä¾‹

```graphql
{
    user(id: "0001") { # ID ãŒ 0001 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
        # åå‰ã¨emailã‚’å–å¾—ã™ã‚‹
        name 
        email
        books { # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹æœ¬æƒ…å ±ã‚‚ä½µã›ã¦å–å¾—ã™ã‚‹
            title
            author
        }
    }
}
```

ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã§è¨€ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªç‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

- ã‚¯ã‚¨ãƒªã‚’é †ç•ªã«å‡¦ç†ã—ã¦ã„ããŸã‚N+1å•é¡ŒãŒç™ºç”Ÿã—ã‚„ã™ã„
    - dataloader ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é…å»¶èª­ã¿è¾¼ã¿ã§å¯¾å¿œ
- å˜ä¸€ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ãŸã‚URLãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¡Œãˆãªã„
    - å°‚ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹
        - Apollo Client
        - Relay

èª¿æŸ»ã‚‚ã»ã©ã»ã©ã«ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€²ã‚ã¦ã¿ã¾ã™ã€‚

---

## å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« (JavaScript)

### [Getting Started](https://graphql.org/graphql-js/)

[è©¦ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰](https://github.com/harusame0616/GraphQL-Official-Training-with-TypeScript/tree/main/01_GraphQL.js_Tutorial)

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æº–å‚™

```sh
npm init -y && npm i ts-node graphql
```

GraphQLã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯ Queryå‹ã§ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©ã¨ã€å®Ÿéš›ã«å‡¦ç†ã‚’è¡Œã† Resolver ã¨å‘¼ã°ã‚Œã‚‹é–¢æ•°ã®å®Ÿè£…ãŒå¿…è¦ã€‚  
ãªãŠã€Queryå‹ã§ã¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’è¡Œã†APIã‚’å®šç¾©ã™ã‚‹ã€‚  
Queryå‹ä»¥å¤–ã«ã‚‚ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã€å¤‰æ›´ã€å‰Šé™¤ã‚’ã™ã‚‹Mutationå‹ã€ã‚¤ãƒ™ãƒ³ãƒˆã®è³¼èª­ã‚’è¡Œã†Subscriptionå‹ãŒã‚ã‚‹ã€‚  
Hello Worldã‚’è¿”ã™Queryå‹APIã®å®Ÿè£…ä¾‹ã€‚  

```ts
import { graphql, buildSchema } from 'graphql';

// Query å‹ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
// æ–‡å­—åˆ—ã‚’è¿”ã™ hello ã¨ã„ã† API ã‚’å®šç¾©ã—ã¦ã„ã‚‹
const schema = buildSchema(`
  type Query {
    hello: String
  }
`);

// ã‚¯ã‚¨ãƒªã‚’å‡¦ç†ã™ã‚‹ãƒªã‚¾ãƒ«ãƒã‚’å®šç¾©
const rootValue = {
  hello: () => {
    return 'Hello world!';
  },
};

const main = async () => {
  const query = '{ hello }';

  // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
  const response = await graphql({
    schema,
    source: query,
    rootValue,
  });

  console.log(response);
};

main();
```

 å®Ÿè¡Œ

```sh
npx ts-node server
```

> { data: [Object: null prototype] { hello: 'Hello world!' } }

### [Running an Express GraphQL Server](https://graphql.org/graphql-js/running-an-express-graphql-server/)

Express ã‚’ä½¿ã£ã¦HTTPã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ãƒã‚¦ãƒ³ãƒˆã§ãã¾ã™ã€‚

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥

```sh
npm init && npm i ts-node graphql express-graphql express @types/express
```

Express ã§ httpã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å®Ÿè£…ä¾‹

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

const schema = buildSchema(`
  type Query {
    hello: String
  }
`);

const root = {
  hello: () => {
    return 'hello world';
  },
};

const app = express();
app.use(
  '/graphql', //  /graphql ã« GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true, // GraphQL ã® Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ GraphiQLã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at http://localhost:4000/graphql');
```

graphqlã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•

```sh
npx ts-node server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ WebUI ã§GraphQLã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã§ãã‚‹ `GraphiQL` ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚

> https://localhost:4000/graphql

ç”»é¢ã®å·¦å´ã«ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒè¿”ã£ã¦ãã‚‹ã€‚

```graphql
{
    hello
}
```

### [GraphQL Clients](https://graphql.org/graphql-js/graphql-clients/)


GraphQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚å­˜åœ¨ã—ã¾ã™ãŒã€å˜ç´”ãª HTTP ã® POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã£ã¦ç°¡å˜ã«ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
REST APIã§ã¯ç”¨é€”ã«ã‚ˆã£ã¦ GET/DELETE/POST/PUT ãªã©ã‚’ä½¿ã„åˆ†ã‘ã¾ã™ãŒã€GraphQL ã§ã¯å…¨ã¦ POSTã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã¾ã™ã€‚  

Express GraphQL Server ã§ä½œæˆã—ãŸGraphQLã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªcurlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨JSONå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

```sh
curl -X POST -H "Content-Type: Application/json" -d '{"Query": "{hello}"}' http://localhost:4000/graphql
```

ã¾ãŸã€GraphQL ã§ã‚‚ API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¼•æ•°ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

queryã«$ã‚’ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã€variablesã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾å¿œã—ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¸¡ã™ã“ã¨ã§å€¤ã‚’è‡ªå‹•çš„ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã§ãã¾ã™ã€‚

```ts
const dice = 3;
const sides = 7;
      
// dice ã¨ sides ã‚’å¤‰æ•°ã¨ã—ã¦æ¸¡ã™ãŸã‚ã« 
// $dice ã¨ $sides ã‚’æŒ‡å®šã—ã¦ã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ã€‚
const query = `query RollDice($dice: Int!, $sides: Int) {
    rollDice(numDice: $dice, numSides: $sides)
}`;

const result = await fetch("/graphql2", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Accept: "application/json",
  },
  body: JSON.stringify({
    query,
    variables: { dice, sides }, // dice ã¨ sides ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
  }),
});
```

### [Basic Types](https://graphql.org/graphql-js/basic-types/)


GraphQLã§ã®åŸºæœ¬å‹ã¨JSã§ã®å¯¾å¿œã¯ä»¥ä¸‹ã€‚

- `String` : æ–‡å­—å‹ â†’ string
- `Int` : æ•´æ•°å‹ â†’ number
- `Float` : ä¸å‹•å°æ•°ç‚¹ â†’ number
- `Boolean` : çœŸå½ â†’ boolean
- `ID` : ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè­˜åˆ¥å­ â†’ string
    - GraphQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã®IDã‚’ã‚‚ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã©ã‚’è¡Œãªã£ã¦ãã‚Œã‚‹ã‚‰ã—ã„

åŸºæœ¬å‹ã¯å…¨ã¦ Nullableã€‚  
Nullã‚’è¨±å®¹ã—ãªã„å ´åˆã¯æœ«å°¾ã« `!`  (eg. String!)  
ãƒªã‚¹ãƒˆå‹ã®å ´åˆã¯ `[]` ã§å›²ã‚€ (eg. [String])  

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

const schema = buildSchema(`
  type Query {
    quoteOfTheDay: String
    random: Float!
    rollThreeDice: [Int]
  }
`);

const root = {
  quoteOfTheDay: () => {
    return Math.random() < 0.5 ? 'Take it easy' : 'Salvation lies within';
  },
  random: () => {
    return Math.random();
  },
  rollThreeDice: () => {
    return [1, 2, 3].map((_) => 1 + Math.floor(Math.random() * 6));
  },
};

const app = express();
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at localhost:4000/graphql');
```

### [Passing Arguments](https://graphql.org/graphql-js/passing-arguments/)


GraphQLã§ã‚‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¼•æ•°ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

å¼•æ•°ã«ã¯åå‰ã¨å‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```graphql
type Query {
  rollDice(numDice: Int!, numSides: Int): [Int]
}
```

numDiceã¯ `!` ã«ã‚ˆã£ã¦nullã§ã¯ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çœç•¥ã§ãã¾ã™ã€‚

å¼•æ•°ãŒã‚ã‚‹APIã§ã¯ãƒªã‚¾ãƒ«ãƒã®æœ€åˆã®å¼•æ•°ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã€‚

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

const schema = buildSchema(`
type Query {
    rollDice(numDice: Int!, numSides: Int): [Int]
}
`);

// RollDice ã®å¼•æ•°å‹
interface RollDiceArgs {
  numDice: number;
  numSides: number;
}

const root = {
  // ãƒªã‚¾ãƒ«ãƒã®ç¬¬ä¸€å¼•æ•°ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã‚‹ã€‚
  rollDice: ({ numDice, numSides }: RollDiceArgs) => {
    const output: number[] = [];

    for (let i = 0; i < numDice; i++) {
      output.push(1 + Math.floor(Math.random() * (numSides || 6)));
    }

    return output;
  },
};

const app = express();
app.use(express.static('public'));
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at localhost:4000/graphql');

```

### [Object Type](https://graphql.org/graphql-js/object-types/)


GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒã§ã¯ç‹¬è‡ªã®æŒ¯ã‚‹èˆã„ã‚’æŒã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
// ç‹¬è‡ªã®æŒ¯ã‚‹èˆã„ã‚’æŒã£ãŸ RandomDie ã‚’å®šç¾©
type RandomDie {
  roll(numRolls: Int!): [Int]
}

type Query {
  // RandomDie ã‚’è¿”ã™ API
  getDie(numSides: Int): RandomDie
}
```

getDie ã¨ RandomDie ã®å®Ÿè£…ä¾‹

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

// RandomDie ã® publicãƒ¡ãƒ³ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã§ã€
// numSides, rollOnceã«ã¤ã„ã¦ã‚‚ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¦ãŠã
const schema = buildSchema(`
type RandomDie {
    numSides: Int!
    rollOnce: Int!
    roll(numRolls: Int!): [Int!]!
}

type Query {
    getDie(numSides: Int): RandomDie
}
`);

class RandomDie {
  constructor(private _numSides: number) {}

  get numSides() {
    return this._numSides;
  }

  rollOnce() {
    return 1 + Math.floor(Math.random() * this._numSides);
  }

  // å¼•æ•°ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§æ¸¡ã•ã‚Œã‚‹ã®ã§åˆ†å‰²ä»£å…¥ã§å—ã‘å–ã£ã¦ã„ã‚‹
  roll({ numRolls }: { numRolls: number }) {
    const output: number[] = [];

    for (let i = 0; i < numRolls; i++) {
      output.push(this.rollOnce());
    }

    return output;
  }
}

interface GetDieArg {
  numSides: number;
}

const root = {
  getDie: ({ numSides }: GetDieArg) => {
    return new RandomDie(numSides || 6);
  },
};

const app = express();
app.use(express.static('public'));
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at localhost:4000/graphql');
```

getDieã§å–å¾—ã—ãŸ RandomDie ã«å¯¾ã—ã¦å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ãŸçµæœãŒè¿”ã£ã¦ãã‚‹ã€‚

```graphql
{
    getDie(numSides: 6) {
        rollOnce
        roll(numRolls: 3)
        numSides
    }
}
```

â†“

```json
{
  "data": {
    "getDie": {
      "rollOnce": 5,
      "roll": [
        5,
        4,
        5
      ],
      "numSides": 6
    }
  }
}
```

### [Mutations and Input Types](https://graphql.org/graphql-js/mutations-and-input-types/)


ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ã‚„ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãªã©ã‚’è¡Œã†APIã§ã¯ Query ã§ã¯ãªã Mutation ã¨ã—ã¦å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ã¨å–å¾—ã™ã‚‹APIã®ã‚¹ã‚­ãƒ¼ãƒ

```graphql
type Mutation {
  setMessage(message: String): String
}

type Query {
  getMessage(message: String): String
}
```

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ã¨å–å¾—ã™ã‚‹APIã®å®Ÿè£…ä¾‹

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

const schema = buildSchema(`
type Mutation {
    setMessage(message:String!): String!
}

type Query {
  getMessage: String!
}
`);

const inmemoryDB = {
  message: 'default',
};

const root = {
  setMessage: ({ message }: { message: string }) => {
    inmemoryDB.message = message;

    return inmemoryDB.message;
  },
  getMessage: () => {
    return inmemoryDB.message;
  },
};

const app = express();
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at localhost:4000/graphql');
```

åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—

```tsx
{
	getMessage
}
```

â†“

```json
{
	"getMessage": "default"
}
```

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°

```tsx
mutation {
	setMessage(message: "hello")
}
```

â†“

```json
{
  "setMessage": "hello"
}
```

æ–°å¾Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—

```graphql
{
	getMessage
}
```

â†“

```json
{
	"getMessage": "hello"
}
```

ã¾ãŸã€åŒã˜å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã®APIã§ä½¿ã†æ™‚ãªã©ã¯ input ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦å…¥åŠ›å‹ã¨ã—ã¦ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```graphql
input MessageInput {
  content: String
  author: String
  # message: Message  -> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã¯ãƒ€ãƒ¡
}

type Message {
  id: ID!
  content: String
  author: String
}

type Query {
  getMessage(id: ID!): Message
}

type Mutation {
  createMessage(input: MessageInput): Message
  updateMessage(id: ID!, input: MessageInput): Message
}
```

å…¥åŠ›ã‚¿ã‚¤ãƒ—ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ã€åŸºæœ¬å‹ã€ãƒªã‚¹ãƒˆå‹ã€å…¥åŠ›å‹ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã¯æŒã¤ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';
import crypto from 'crypto';

const schema = buildSchema(`
  input MessageInput {
    content: String
    author: String
  }

  type Message {
    id: ID!
    content: String
    author: String
  }

  type Query {
    getMessage(id: ID!): Message
  }

  type Mutation {
    createMessage(input: MessageInput): Message
    updateMessage(id: ID!, input: MessageInput): Message
  }
`);

interface MessageInput {
  content: string;
  author: string;
}

class Message {
  private _content: string;
  private _author: string;
  constructor(private _id: string, { content, author }: MessageInput) {
    this._content = content;
    this._author = author;
  }

  get id() {
    return this._id;
  }

  get content() {
    return this._content;
  }
  get author() {
    return this._author;
  }
}

type MessageInfo = {
  content: string;
  author: string;
};

const inmemoryDB: {
  [key: string]: MessageInfo;
} = {};

const root = {
  getMessage: ({ id }: { id: string }) => {
    if (!inmemoryDB[id]) {
      throw new Error('no message exists with id ' + id);
    }

    return new Message(id, inmemoryDB[id]);
  },
  createMessage: ({ input }: { input: MessageInfo }) => {
    const id = crypto.randomUUID();

    inmemoryDB[id] = input;
    return new Message(id, input);
  },
  updateMessage: ({ id, input }: { id: string; input: MessageInput }) => {
    if (!inmemoryDB[id]) {
      throw new Error('no message exists with id ' + id);
    }

    inmemoryDB[id] = input;
    return new Message(id, input);
  },
};

const app = express();
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
  })
);

app.listen(4001, () => {
  console.log('Running a GraphQL API server2 at localhost:4001/graphql');
});
```

### [Authentication and Express Middleware](https://graphql.org/graphql-js/authentication-and-express-middleware/)


express-graphqlã¨çµ„ã¿åˆã‚ã›ã¦ã€ExpressãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ç°¡å˜ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

ã¾ãŸã€ãƒªã‚¾ãƒ«ãƒã§ã¯ç¬¬ï¼’å¼•æ•°ã‹ã‚‰requestã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
import express from 'express';
import { graphqlHTTP } from 'express-graphql';
import { buildSchema } from 'graphql';

var schema = buildSchema(`
  type Query {
    ip: String
  }
`);

const loggingMiddleware = (
  req: express.Request,
  res: express.Response,
  next: express.NextFunction
) => {
  console.log('ip:', req.ip);
  next();
};

const root = {
  ip: (_args: any, context: express.Request) => {
    // graphqlHTTP ã® context ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ãªã„ã®ã§
    // ç¬¬äºŒå¼•æ•°ã«ã¯ express.Request ã®å€¤ãŒæ¸¡ã•ã‚Œã‚‹
    return context.ip;
  },
};

const app = express();
app.use(loggingMiddleware);
app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true,
    // resolver ã®ç¬¬äºŒå¼•æ•°ã«æ¸¡ã™å€¤ã€‚æŒ‡å®šã—ãªã„ã¨ requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¸¡ã•ã‚Œã‚‹
    // context: { hoge: 'context' }, 
  })
);

app.listen(4000);
console.log('Running a GraphQL API server at localhost:4000/graphql');
```

---

ã•ã£ãã‚Šã¨ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

å‹å®‰å…¨ãªä»•çµ„ã¿ã¯é–‹ç™ºä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹ç´ æ™´ã‚‰ã—ã„ä»•çµ„ã¿ã ã¨æ€ã†ã®ã§ã€å¼•ãç¶šãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰typescriptã®å‹ã‚’ç”Ÿæˆã™ã‚‹ code generator ãªã©è‰²ã€…è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚